# Ralph-dev System Architecture

Comprehensive architecture documentation with text-based flowcharts for the autonomous end-to-end development system.

---

## Table of Contents

1. [High-Level System Overview](#1-high-level-system-overview)
2. [5-Phase Workflow State Machine](#2-5-phase-workflow-state-machine)
3. [CLI Layered Architecture](#3-cli-layered-architecture)
4. [Data Flow Diagrams](#4-data-flow-diagrams)
5. [Directory Structure](#5-directory-structure)
6. [Component Interaction Diagrams](#6-component-interaction-diagrams)
7. [Error Handling & Recovery](#7-error-handling--recovery)

---

## 1. High-Level System Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           RALPH-DEV SYSTEM                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────────┐    ┌───────────────┐    ┌───────────────┐              │
│   │  Claude Code  │◄──►│  Plugin Layer │◄──►│  Skills Layer │              │
│   │    (Host)     │    │(.claude-plugin)│    │   (skills/)   │              │
│   └───────────────┘    └───────────────┘    └───────────────┘              │
│          │                     │                    │                       │
│          │                     │                    │                       │
│          ▼                     ▼                    ▼                       │
│   ┌─────────────────────────────────────────────────────────────┐          │
│   │                    CLI Tool (cli/)                           │          │
│   │  ┌─────────┐  ┌──────────┐  ┌────────────┐  ┌────────────┐  │          │
│   │  │Commands │─►│ Services │─►│Repositories│─►│   Domain   │  │          │
│   │  └─────────┘  └──────────┘  └────────────┘  └────────────┘  │          │
│   │                                    │                         │          │
│   │                                    ▼                         │          │
│   │                           ┌────────────────┐                 │          │
│   │                           │ Infrastructure │                 │          │
│   │                           └────────────────┘                 │          │
│   └─────────────────────────────────────────────────────────────┘          │
│          │                                                                  │
│          ▼                                                                  │
│   ┌─────────────────────────────────────────────────────────────┐          │
│   │                  Workspace (.ralph-dev/)                     │          │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │          │
│   │  │state.json│  │  prd.md  │  │  tasks/  │  │  logs/   │    │          │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │          │
│   └─────────────────────────────────────────────────────────────┘          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Component Descriptions

| Component | Location | Purpose |
|-----------|----------|---------|
| Claude Code | Host IDE | AI assistant runtime environment |
| Plugin Layer | `.claude-plugin/` | Session hooks, CLI bootstrap |
| Skills Layer | `skills/` | Phase-specific AI workflows |
| CLI Tool | `cli/` | State & task management |
| Workspace | `.ralph-dev/` | Persistent project state |

---

## 2. 5-Phase Workflow State Machine

### Main Workflow Flow

```
                        ┌──────────────────────────────────────────────────────┐
                        │              RALPH-DEV WORKFLOW                      │
                        └──────────────────────────────────────────────────────┘

     ┌─────────┐      ┌───────────┐      ┌───────────┐      ┌─────────┐      ┌──────────┐
     │ CLARIFY │─────►│ BREAKDOWN │─────►│ IMPLEMENT │─────►│ DELIVER │─────►│ COMPLETE │
     └─────────┘      └───────────┘      └───────────┘      └─────────┘      └──────────┘
          │                │                   │ ▲               │
          │                │                   │ │               │
          ▼                ▼                   ▼ │               ▼
    ┌──────────┐     ┌──────────┐        ┌──────┴──┐      ┌──────────┐
    │ Generate │     │  Create  │        │  HEAL   │      │  Create  │
    │   PRD    │     │  Tasks   │        │ (retry) │      │   PR     │
    └──────────┘     └──────────┘        └─────────┘      └──────────┘
```

### State Transition Rules

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     VALID STATE TRANSITIONS                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│    ┌─────────┐                                                          │
│    │ clarify │──────────────────┐                                       │
│    └─────────┘                  │                                       │
│         │                       ▼                                       │
│         │              ┌────────────┐                                   │
│         └─────────────►│ breakdown  │                                   │
│                        └────────────┘                                   │
│                              │                                          │
│                              ▼                                          │
│                       ┌────────────┐                                    │
│              ┌───────►│ implement  │◄───────┐                           │
│              │        └────────────┘        │                           │
│              │         │         │          │                           │
│              │    error│         │all done  │                           │
│              │         ▼         │          │                           │
│              │    ┌─────────┐    │          │                           │
│              │    │  heal   │────┘          │                           │
│              │    └─────────┘               │                           │
│              │         │ fixed              │                           │
│              └─────────┘                    │                           │
│                                             ▼                           │
│                                      ┌────────────┐                     │
│                                      │  deliver   │                     │
│                                      └────────────┘                     │
│                                             │                           │
│                                             ▼                           │
│                                      ┌────────────┐                     │
│                                      │  complete  │                     │
│                                      └────────────┘                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Phase Details

```
┌─────────────────────────────────────────────────────────────────────────┐
│ PHASE 1: CLARIFY                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   User Input                                                            │
│       │                                                                 │
│       ▼                                                                 │
│   ┌──────────────────┐                                                  │
│   │ Analyze Request  │                                                  │
│   └──────────────────┘                                                  │
│       │                                                                 │
│       ▼                                                                 │
│   ┌──────────────────┐     ┌──────────────────┐                         │
│   │ Generate 3-5     │────►│ AskUserQuestion  │                         │
│   │ Questions        │     │ (collect answers)│                         │
│   └──────────────────┘     └──────────────────┘                         │
│                                   │                                     │
│                                   ▼                                     │
│                            ┌──────────────────┐                         │
│                            │ Generate PRD     │                         │
│                            └──────────────────┘                         │
│                                   │                                     │
│                                   ▼                                     │
│                            ┌──────────────────┐                         │
│                            │ .ralph-dev/prd.md│                         │
│                            └──────────────────┘                         │
│                                                                         │
│   Output: Product Requirements Document                                 │
│   Transition: → breakdown                                               │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ PHASE 2: BREAKDOWN                                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   .ralph-dev/prd.md                                                     │
│       │                                                                 │
│       ▼                                                                 │
│   ┌──────────────────┐                                                  │
│   │ Parse PRD        │                                                  │
│   │ (requirements)   │                                                  │
│   └──────────────────┘                                                  │
│       │                                                                 │
│       ▼                                                                 │
│   ┌──────────────────┐     ┌──────────────────┐                         │
│   │ For each         │────►│ ralph-dev tasks  │                         │
│   │ requirement      │     │ create <id> ...  │                         │
│   └──────────────────┘     └──────────────────┘                         │
│                                   │                                     │
│                                   ▼                                     │
│                            ┌──────────────────┐                         │
│                            │ .ralph-dev/tasks/│                         │
│                            │ {module}/{id}.md │                         │
│                            └──────────────────┘                         │
│                                   │                                     │
│                                   ▼                                     │
│                            ┌──────────────────┐                         │
│                            │ AskUserQuestion  │                         │
│                            │ (get approval)   │                         │
│                            └──────────────────┘                         │
│                                                                         │
│   Output: Atomic tasks with dependencies                                │
│   Transition: → implement (after user approval)                         │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ PHASE 3: IMPLEMENT                                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                     IMPLEMENTATION LOOP                          │   │
│   │                                                                  │   │
│   │   ┌───────────────────┐                                          │   │
│   │   │ralph-dev tasks    │                                          │   │
│   │   │next --json        │◄─────────────────────────────────┐       │   │
│   │   └───────────────────┘                                  │       │   │
│   │          │                                               │       │   │
│   │          │ task found                                    │       │   │
│   │          ▼                                               │       │   │
│   │   ┌───────────────────┐                                  │       │   │
│   │   │ralph-dev tasks    │                                  │       │   │
│   │   │start <id>         │                                  │       │   │
│   │   └───────────────────┘                                  │       │   │
│   │          │                                               │       │   │
│   │          ▼                                               │       │   │
│   │   ┌───────────────────┐                                  │       │   │
│   │   │ Task tool         │ (fresh subagent)                 │       │   │
│   │   │ - Write tests     │                                  │       │   │
│   │   │ - Implement code  │                                  │       │   │
│   │   │ - Verify tests    │                                  │       │   │
│   │   └───────────────────┘                                  │       │   │
│   │          │                                               │       │   │
│   │          ▼                                               │       │   │
│   │   ┌──────┴──────┐                                        │       │   │
│   │   │   Result?   │                                        │       │   │
│   │   └──────┬──────┘                                        │       │   │
│   │     success│fail                                         │       │   │
│   │          │  │                                            │       │   │
│   │          ▼  ▼                                            │       │   │
│   │   ┌─────────┐ ┌─────────┐                                │       │   │
│   │   │ tasks   │ │ Invoke  │                                │       │   │
│   │   │ done    │ │ HEAL    │                                │       │   │
│   │   │ <id>    │ │ phase   │                                │       │   │
│   │   └─────────┘ └─────────┘                                │       │   │
│   │          │         │                                     │       │   │
│   │          └────┬────┘                                     │       │   │
│   │               │                                          │       │   │
│   │               └──────────────────────────────────────────┘       │   │
│   │                                                                  │   │
│   │   Exit condition: ralph-dev tasks next → null (no more tasks)    │   │
│   └──────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   Output: Implemented & tested code                                     │
│   Transition: → deliver (all tasks done)                                │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ PHASE 4: HEAL                                                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Failed Task + Error                                                   │
│       │                                                                 │
│       ▼                                                                 │
│   ┌──────────────────┐                                                  │
│   │ 1. INVESTIGATE   │                                                  │
│   │   - Read error   │                                                  │
│   │   - Reproduce    │                                                  │
│   │   - Trace flow   │                                                  │
│   └──────────────────┘                                                  │
│       │                                                                 │
│       ▼                                                                 │
│   ┌──────────────────┐                                                  │
│   │ 2. ANALYZE       │                                                  │
│   │   - Find working │                                                  │
│   │     examples     │                                                  │
│   │   - Compare code │                                                  │
│   └──────────────────┘                                                  │
│       │                                                                 │
│       ▼                                                                 │
│   ┌──────────────────┐     ┌──────────────────┐                         │
│   │ 3. HYPOTHESIS    │────►│ WebSearch        │                         │
│   │   - Classify     │     │ (confirm)        │                         │
│   │     error type   │     └──────────────────┘                         │
│   └──────────────────┘                                                  │
│       │                                                                 │
│       ▼                                                                 │
│   ┌──────────────────┐                                                  │
│   │ 4. FIX & VERIFY  │◄────────────────┐                                │
│   │   - Apply fix    │                 │                                │
│   │   - Run tests    │                 │ retry (max 3)                  │
│   └──────────────────┘                 │                                │
│       │                                │                                │
│       ▼                                │                                │
│   ┌──────┴──────┐                      │                                │
│   │   Pass?     │───────── no ─────────┘                                │
│   └──────┬──────┘                                                       │
│          │ yes                                                          │
│          ▼                                                              │
│   ┌──────────────────┐                                                  │
│   │ Return to        │                                                  │
│   │ IMPLEMENT        │                                                  │
│   └──────────────────┘                                                  │
│                                                                         │
│   Circuit Breaker: 5 consecutive failures → mark task failed, skip      │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ PHASE 5: DELIVER                                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   All Tasks Completed                                                   │
│       │                                                                 │
│       ▼                                                                 │
│   ┌──────────────────┐                                                  │
│   │ QUALITY GATES    │                                                  │
│   │ ┌──────────────┐ │                                                  │
│   │ │ npm test     │ │                                                  │
│   │ ├──────────────┤ │                                                  │
│   │ │ npm run lint │ │                                                  │
│   │ ├──────────────┤ │                                                  │
│   │ │ tsc --noEmit │ │                                                  │
│   │ ├──────────────┤ │                                                  │
│   │ │ npm run build│ │                                                  │
│   │ └──────────────┘ │                                                  │
│   └──────────────────┘                                                  │
│       │                                                                 │
│       │ all pass                                                        │
│       ▼                                                                 │
│   ┌──────────────────┐                                                  │
│   │ CODE REVIEW      │                                                  │
│   │ - Spec compliance│                                                  │
│   │ - Code quality   │                                                  │
│   └──────────────────┘                                                  │
│       │                                                                 │
│       ▼                                                                 │
│   ┌──────────────────┐     ┌──────────────────┐                         │
│   │ git commit       │────►│ gh pr create     │                         │
│   └──────────────────┘     └──────────────────┘                         │
│                                   │                                     │
│                                   ▼                                     │
│                            ┌──────────────────┐                         │
│                            │ PR URL returned  │                         │
│                            └──────────────────┘                         │
│                                                                         │
│   Output: Git commit + Pull Request                                     │
│   Transition: → complete                                                │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. CLI Layered Architecture

### Layer Dependency Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     CLI LAYERED ARCHITECTURE                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    COMMANDS LAYER                                │   │
│   │                    (cli/src/commands/)                           │   │
│   │                                                                  │   │
│   │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │   │
│   │   │state.ts │ │tasks.ts │ │detect.ts│ │ init.ts │ │status.ts│  │   │
│   │   └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘  │   │
│   │                                                                  │   │
│   │   Responsibility: Parse args, call services, format output       │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              │ uses                                     │
│                              ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                   SERVICES LAYER                                 │   │
│   │                   (cli/src/services/)                            │   │
│   │                                                                  │   │
│   │   ┌────────────────┐  ┌────────────────┐  ┌─────────────────┐   │   │
│   │   │ StateService   │  │ TaskService    │  │ StatusService   │   │   │
│   │   │ - updateState  │  │ - lifecycle    │  │ - summary       │   │   │
│   │   │ - validation   │  │ - dependencies │  │ - progress      │   │   │
│   │   └────────────────┘  └────────────────┘  └─────────────────┘   │   │
│   │                                                                  │   │
│   │   Responsibility: Business logic, validation, orchestration      │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              │ uses                                     │
│                              ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                 REPOSITORIES LAYER                               │   │
│   │                 (cli/src/repositories/)                          │   │
│   │                                                                  │   │
│   │   ┌──────────────────────┐  ┌──────────────────────┐            │   │
│   │   │ IStateRepository     │  │ ITaskRepository      │            │   │
│   │   │ (interface)          │  │ (interface)          │            │   │
│   │   │   │                  │  │   │                  │            │   │
│   │   │   ▼                  │  │   ▼                  │            │   │
│   │   │ StateRepository      │  │ TaskRepository       │            │   │
│   │   │ .service.ts          │  │ .service.ts          │            │   │
│   │   └──────────────────────┘  └──────────────────────┘            │   │
│   │                                                                  │   │
│   │   Responsibility: Data access abstraction                        │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              │ uses                                     │
│                              ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    DOMAIN LAYER                                  │   │
│   │                    (cli/src/domain/)                             │   │
│   │                                                                  │   │
│   │   ┌──────────────────────┐  ┌──────────────────────┐            │   │
│   │   │ State (Entity)       │  │ Task (Entity)        │            │   │
│   │   │ - phase transitions  │  │ - status lifecycle   │            │   │
│   │   │ - canTransitionTo()  │  │ - isBlocked()        │            │   │
│   │   │ - getNextAllowed()   │  │ - start()/done()     │            │   │
│   │   └──────────────────────┘  └──────────────────────┘            │   │
│   │                                                                  │   │
│   │   Responsibility: Business rules, invariants, behaviors          │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                              │                                          │
│                              │ uses                                     │
│                              ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                 INFRASTRUCTURE LAYER                             │   │
│   │                 (cli/src/infrastructure/)                        │   │
│   │                                                                  │   │
│   │   ┌──────────────────────────┐  ┌────────────────────────────┐  │   │
│   │   │ FileSystem.service.ts    │  │ Logger.service.ts          │  │   │
│   │   │ - readFile/writeFile     │  │ - debug/info/warn/error    │  │   │
│   │   │ - ensureDir/remove       │  │ - logging abstraction      │  │   │
│   │   └──────────────────────────┘  └────────────────────────────┘  │   │
│   │                                                                  │   │
│   │   Responsibility: File I/O, logging, retry, external systems     │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Dependency Injection

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    DEPENDENCY INJECTION                                 │
│                    (service-factory.ts)                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   createTaskService(workspaceDir)                                       │
│       │                                                                 │
│       ▼                                                                 │
│   ┌────────────────────────────────────────────────────────────────┐    │
│   │                                                                │    │
│   │   FileSystemService ─────────┐                                 │    │
│   │         │                    │                                 │    │
│   │         ▼                    ▼                                 │    │
│   │   TaskRepository        StateRepository                        │    │
│   │         │                    │                                 │    │
│   │         └────────┬───────────┘                                 │    │
│   │                  ▼                                             │    │
│   │            TaskService ◄──── Logger                            │    │
│   │                  │                                             │    │
│   │                  ▼                                             │    │
│   │            [returned]                                          │    │
│   │                                                                │    │
│   └────────────────────────────────────────────────────────────────┘    │
│                                                                         │
│   Benefits:                                                             │
│   - Easy to mock for testing                                            │
│   - Single configuration point                                          │
│   - Swappable implementations                                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Data Flow Diagrams

### Phase 1-2: Clarify to Breakdown

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    CLARIFY → BREAKDOWN DATA FLOW                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   USER                                                                  │
│     │                                                                   │
│     │ "Build a user auth system"                                        │
│     ▼                                                                   │
│   ┌─────────────────┐                                                   │
│   │ Phase 1 Skill   │                                                   │
│   │ (clarify)       │                                                   │
│   └─────────────────┘                                                   │
│     │                                                                   │
│     │ AskUserQuestion                                                   │
│     ▼                                                                   │
│   ┌─────────────────┐       ┌─────────────────┐                         │
│   │ Q1: Auth type?  │◄─────►│ User Response   │                         │
│   │ Q2: OAuth?      │       │ - JWT           │                         │
│   │ Q3: 2FA?        │       │ - No OAuth      │                         │
│   └─────────────────┘       │ - Yes 2FA       │                         │
│     │                       └─────────────────┘                         │
│     │                                                                   │
│     ▼                                                                   │
│   ┌─────────────────┐                                                   │
│   │ Generate PRD    │                                                   │
│   └─────────────────┘                                                   │
│     │                                                                   │
│     │ Write                                                             │
│     ▼                                                                   │
│   ┌─────────────────────────────────────────────┐                       │
│   │ .ralph-dev/prd.md                           │                       │
│   │ ┌─────────────────────────────────────────┐ │                       │
│   │ │ # User Authentication System            │ │                       │
│   │ │ ## Requirements                         │ │                       │
│   │ │ - JWT-based auth                        │ │                       │
│   │ │ - 2FA support                           │ │                       │
│   │ │ ## User Stories                         │ │                       │
│   │ │ - As a user, I can login...             │ │                       │
│   │ └─────────────────────────────────────────┘ │                       │
│   └─────────────────────────────────────────────┘                       │
│     │                                                                   │
│     │ state set --phase breakdown                                       │
│     ▼                                                                   │
│   ┌─────────────────┐                                                   │
│   │ Phase 2 Skill   │                                                   │
│   │ (breakdown)     │                                                   │
│   └─────────────────┘                                                   │
│     │                                                                   │
│     │ Parse PRD                                                         │
│     ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                                                                 │   │
│   │   for each requirement:                                         │   │
│   │       ralph-dev tasks create <id> --module <mod> --priority <p> │   │
│   │                                                                 │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│     │                                                                   │
│     │ Creates files                                                     │
│     ▼                                                                   │
│   ┌─────────────────────────────────────────────┐                       │
│   │ .ralph-dev/tasks/                           │                       │
│   │ ├── auth/                                   │                       │
│   │ │   ├── auth.login.md                       │                       │
│   │ │   ├── auth.signup.md                      │                       │
│   │ │   └── auth.2fa.md                         │                       │
│   │ └── index.json                              │                       │
│   └─────────────────────────────────────────────┘                       │
│     │                                                                   │
│     │ AskUserQuestion (approval)                                        │
│     ▼                                                                   │
│   ┌─────────────────┐                                                   │
│   │ User: "Approve" │                                                   │
│   └─────────────────┘                                                   │
│     │                                                                   │
│     │ state set --phase implement                                       │
│     ▼                                                                   │
│   ┌─────────────────┐                                                   │
│   │ state.json      │                                                   │
│   │ {phase:         │                                                   │
│   │  "implement"}   │                                                   │
│   └─────────────────┘                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Phase 3-4: Implement with Healing

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    IMPLEMENT ⇄ HEAL DATA FLOW                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ MAIN ORCHESTRATOR (Phase 3 Skill)                                │   │
│   │                                                                  │   │
│   │   ┌──────────────┐                                               │   │
│   │   │ ralph-dev    │                                               │   │
│   │   │ tasks next   │──────┐                                        │   │
│   │   │ --json       │      │                                        │   │
│   │   └──────────────┘      │                                        │   │
│   │                         ▼                                        │   │
│   │                  ┌──────────────────────────┐                    │   │
│   │                  │ {                        │                    │   │
│   │                  │   "task": {              │                    │   │
│   │                  │     "id": "auth.login",  │                    │   │
│   │                  │     "module": "auth",    │                    │   │
│   │                  │     "status": "pending"  │                    │   │
│   │                  │   }                      │                    │   │
│   │                  │ }                        │                    │   │
│   │                  └──────────────────────────┘                    │   │
│   │                         │                                        │   │
│   │                         ▼                                        │   │
│   │   ┌──────────────────────────────────────────────────────────┐   │   │
│   │   │                   SUBAGENT (Task tool)                    │   │   │
│   │   │                                                          │   │   │
│   │   │   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐  │   │   │
│   │   │   │  Read   │──►│  Write  │──►│  Bash   │──►│ Report  │  │   │   │
│   │   │   │  Task   │   │  Tests  │   │CI=true  │   │ Result  │  │   │   │
│   │   │   │  File   │   │  First  │   │npm test │   │         │  │   │   │
│   │   │   └─────────┘   └─────────┘   └─────────┘   └─────────┘  │   │   │
│   │   │                                    │                      │   │   │
│   │   │                              ┌─────┴─────┐                │   │   │
│   │   │                              │  Result   │                │   │   │
│   │   │                              └───────────┘                │   │   │
│   │   │                                                          │   │   │
│   │   └──────────────────────────────────────────────────────────┘   │   │
│   │                         │                                        │   │
│   │                         ▼                                        │   │
│   │                  ┌──────┴──────┐                                 │   │
│   │                  │  Success?   │                                 │   │
│   │                  └──────┬──────┘                                 │   │
│   │                    yes  │  no                                    │   │
│   │                    ─────┴─────                                   │   │
│   │                   │           │                                  │   │
│   │                   ▼           ▼                                  │   │
│   │           ┌──────────┐  ┌──────────────────┐                     │   │
│   │           │ tasks    │  │ Invoke Phase 4   │                     │   │
│   │           │ done     │  │ (Heal)           │                     │   │
│   │           │ <id>     │  └──────────────────┘                     │   │
│   │           └──────────┘         │                                 │   │
│   │                                ▼                                 │   │
│   └────────────────────────────────┼─────────────────────────────────┘   │
│                                    │                                     │
│   ┌────────────────────────────────┼─────────────────────────────────┐   │
│   │ HEALING FLOW (Phase 4 Skill)   │                                 │   │
│   │                                ▼                                 │   │
│   │   ┌─────────────────────────────────────────────────────────┐    │   │
│   │   │ 1. INVESTIGATE                                          │    │   │
│   │   │    - Read error output                                  │    │   │
│   │   │    - Reproduce with: CI=true npm test                   │    │   │
│   │   │    - Check: git diff HEAD~1                             │    │   │
│   │   └─────────────────────────────────────────────────────────┘    │   │
│   │                                │                                 │   │
│   │                                ▼                                 │   │
│   │   ┌─────────────────────────────────────────────────────────┐    │   │
│   │   │ 2. PATTERN ANALYSIS                                     │    │   │
│   │   │    - Grep: find working examples                        │    │   │
│   │   │    - Read: compare working vs broken                    │    │   │
│   │   └─────────────────────────────────────────────────────────┘    │   │
│   │                                │                                 │   │
│   │                                ▼                                 │   │
│   │   ┌─────────────────────────────────────────────────────────┐    │   │
│   │   │ 3. HYPOTHESIS + WebSearch                               │    │   │
│   │   │    - Classify: type_error | import_error | test_failure │    │   │
│   │   │    - WebSearch: "[error type] [framework] solution"     │    │   │
│   │   └─────────────────────────────────────────────────────────┘    │   │
│   │                                │                                 │   │
│   │                                ▼                                 │   │
│   │   ┌─────────────────────────────────────────────────────────┐    │   │
│   │   │ 4. FIX & VERIFY (max 3 attempts)                        │    │   │
│   │   │                                                         │    │   │
│   │   │    attempt_count = 0                                    │    │   │
│   │   │    while attempt_count < 3:                             │    │   │
│   │   │        Edit: apply single fix                           │    │   │
│   │   │        Bash: CI=true npm test                           │    │   │
│   │   │        if pass: return success                          │    │   │
│   │   │        attempt_count++                                  │    │   │
│   │   │                                                         │    │   │
│   │   │    return failed                                        │    │   │
│   │   └─────────────────────────────────────────────────────────┘    │   │
│   │                                │                                 │   │
│   │                                ▼                                 │   │
│   │                         ┌──────┴──────┐                          │   │
│   │                         │   Fixed?    │                          │   │
│   │                         └──────┬──────┘                          │   │
│   │                           yes  │  no                             │   │
│   │                           ─────┴─────                            │   │
│   │                          │           │                           │   │
│   │                          ▼           ▼                           │   │
│   │                  ┌──────────┐  ┌──────────────┐                   │   │
│   │                  │ Return   │  │ tasks fail   │                   │   │
│   │                  │ to       │  │ <id>         │                   │   │
│   │                  │ Implement│  │ --reason ... │                   │   │
│   │                  └──────────┘  └──────────────┘                   │   │
│   │                                                                  │   │
│   └──────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Task Lifecycle State Machine

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      TASK LIFECYCLE                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                     ┌─────────────┐                                     │
│                     │   pending   │◄──────────── [created]              │
│                     └─────────────┘                                     │
│                            │                                            │
│                            │ tasks start <id>                           │
│                            ▼                                            │
│                     ┌─────────────┐                                     │
│                     │ in_progress │                                     │
│                     └─────────────┘                                     │
│                       │         │                                       │
│           tasks done  │         │  tasks fail                           │
│           <id>        │         │  <id> --reason                        │
│                       ▼         ▼                                       │
│               ┌───────────┐  ┌──────────┐                               │
│               │ completed │  │  failed  │                               │
│               └───────────┘  └──────────┘                               │
│                                                                         │
│   Task File (.ralph-dev/tasks/{module}/{id}.md):                        │
│   ┌─────────────────────────────────────────────┐                       │
│   │ ---                                         │                       │
│   │ id: auth.login                              │                       │
│   │ module: auth                                │                       │
│   │ priority: 1                                 │                       │
│   │ status: pending → in_progress → completed   │                       │
│   │ estimatedMinutes: 30                        │                       │
│   │ dependencies: [setup.scaffold]              │                       │
│   │ ---                                         │                       │
│   │                                             │                       │
│   │ # Description                               │                       │
│   │ ...                                         │                       │
│   └─────────────────────────────────────────────┘                       │
│                                                                         │
│   Index File (.ralph-dev/tasks/index.json):                             │
│   ┌─────────────────────────────────────────────┐                       │
│   │ {                                           │                       │
│   │   "tasks": {                                │                       │
│   │     "auth.login": {                         │                       │
│   │       "id": "auth.login",                   │                       │
│   │       "status": "completed",                │                       │
│   │       "completedAt": "2026-01-20T..."       │                       │
│   │     },                                      │                       │
│   │     ...                                     │                       │
│   │   }                                         │                       │
│   │ }                                           │                       │
│   └─────────────────────────────────────────────┘                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Directory Structure

```
ralph-dev/
│
├── .claude-plugin/                    # PLUGIN LAYER
│   ├── plugin.json                   # Plugin metadata & hooks
│   └── hooks/
│       ├── session-start.sh          # Build CLI on session start
│       └── pre-compact.sh            # Save state before compression
│
├── cli/                              # CLI TOOL
│   ├── src/
│   │   ├── commands/                 # [Layer 1: Commands]
│   │   │   ├── state.ts              #   State management commands
│   │   │   ├── tasks.ts              #   Task management commands
│   │   │   ├── detect.ts             #   Language detection
│   │   │   ├── init.ts               #   Initialize workspace
│   │   │   ├── status.ts             #   Status summary
│   │   │   └── service-factory.ts    #   Dependency injection
│   │   │
│   │   ├── services/                 # [Layer 2: Services]
│   │   │   ├── state-service.ts      #   State management
│   │   │   ├── task-service.ts       #   Task lifecycle
│   │   │   ├── status-service.ts     #   Status summary
│   │   │   └── detection-service.ts  #   Lang detection logic
│   │   │
│   │   ├── repositories/             # [Layer 3: Repositories]
│   │   │   ├── state-repository.ts   #   State interface
│   │   │   ├── task-repository.ts    #   Task interface
│   │   │   └── *.service.ts          #   File-based implementations
│   │   │
│   │   ├── domain/                   # [Layer 4: Domain]
│   │   │   ├── state-entity.ts       #   State with transitions
│   │   │   └── task-entity.ts        #   Task with lifecycle
│   │   │
│   │   ├── infrastructure/           # [Layer 5: Infrastructure]
│   │   │   ├── file-system.service.ts #   File I/O operations
│   │   │   └── logger.service.ts      #   Logging
│   │   │
│   │   ├── core/                     # Utilities
│   │   │   ├── task-parser.ts        #   YAML frontmatter parser
│   │   │   ├── task-writer.ts        #   Task file writer
│   │   │   └── exit-codes.ts         #   Standard exit codes
│   │   │
│   │   └── index.ts                  # CLI entry point
│   │
│   ├── package.json                  # Dependencies
│   └── dist/                         # Compiled output
│
├── skills/                           # AI WORKFLOWS
│   ├── phase-1-clarify/
│   │   └── SKILL.md                  # Requirement clarification
│   ├── phase-2-breakdown/
│   │   └── SKILL.md                  # Task decomposition
│   ├── phase-3-implement/
│   │   ├── SKILL.md                  # Implementation loop
│   │   └── implementer-prompt-v2.md  # Subagent template
│   ├── phase-4-heal/
│   │   └── SKILL.md                  # Error recovery
│   ├── phase-5-deliver/
│   │   └── SKILL.md                  # Quality gates & PR
│   └── dev-orchestrator/
│       └── SKILL.md                  # Main orchestrator
│
├── commands/                         # USER COMMANDS
│   └── ralph-dev.md                  # /ralph-dev command
│
├── .ralph-dev/                       # WORKSPACE (runtime)
│   ├── state.json                   # Current phase & progress
│   ├── prd.md                       # Product requirements
│   └── tasks/
│       ├── index.json               # Task metadata index
│       └── {module}/{id}.md         # Individual tasks
│
├── .claude/
│   └── rules/                        # Workflow documentation
│       ├── ralph-dev-workflow.md
│       ├── ralph-dev-principles.md
│       └── ralph-dev-commands.md
│
└── docs/                             # Documentation
    ├── ARCHITECTURE.md              # This file
    ├── CONFIGURATION.md
    └── QUICK_START_V0.3.md
```

---

## 6. Component Interaction Diagrams

### Plugin Bootstrap Sequence

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SESSION START SEQUENCE                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Claude Code Session Start                                             │
│         │                                                               │
│         │ triggers SessionStart hook                                    │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ .claude-plugin/hooks/session-start.sh │                             │
│   └─────────────────────────────────────┘                               │
│         │                                                               │
│         │ executes                                                      │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ shared/bootstrap-cli.sh             │                               │
│   │                                     │                               │
│   │   if [ ! -d "cli/dist" ]; then      │                               │
│   │       cd cli && npm install         │                               │
│   │       npm run build                 │                               │
│   │   fi                                │                               │
│   └─────────────────────────────────────┘                               │
│         │                                                               │
│         │ CLI ready                                                     │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ ralph-dev available                 │                               │
│   └─────────────────────────────────────┘                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Context Compression Recovery

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    CONTEXT COMPRESSION RECOVERY                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Context Near Limit                                                    │
│         │                                                               │
│         │ triggers PreCompact hook                                      │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ .claude-plugin/hooks/pre-compact.sh │                               │
│   │                                     │                               │
│   │   ralph-dev state get --json        │  ← Save current state         │
│   │   ralph-dev tasks list --json       │  ← Save task progress         │
│   └─────────────────────────────────────┘                               │
│         │                                                               │
│         │ context compressed                                            │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ Session Resumes (new context)       │                               │
│   └─────────────────────────────────────┘                               │
│         │                                                               │
│         │ Skill reads rules                                             │
│         ▼                                                               │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ RECOVERY SEQUENCE (from ralph-dev-workflow.md)                   │   │
│   │                                                                  │   │
│   │   Step 1: ralph-dev state get --json                             │   │
│   │           → {phase: "implement", currentTask: "auth.2fa"}        │   │
│   │                                                                  │   │
│   │   Step 2: ralph-dev tasks list --json                            │   │
│   │           → {completed: 5, pending: 3, failed: 1}                │   │
│   │                                                                  │   │
│   │   Step 3: ralph-dev tasks next --json                            │   │
│   │           → {task: {id: "auth.2fa"}}                             │   │
│   │                                                                  │   │
│   │   Step 4: Resume appropriate phase skill                         │   │
│   │           → Skill "ralph-dev:phase-3-implement"                  │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Skill Invocation Chain

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    SKILL INVOCATION CHAIN                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   User: /ralph-dev                                                      │
│         │                                                               │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ dev-orchestrator/SKILL.md           │                               │
│   │                                     │                               │
│   │   Check phase: ralph-dev state get  │                               │
│   └─────────────────────────────────────┘                               │
│         │                                                               │
│         │ phase = "none" (new session)                                  │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ Skill tool: ralph-dev:phase-1-clarify │                             │
│   └─────────────────────────────────────┘                               │
│         │                                                               │
│         │ PRD generated                                                 │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ Skill tool: ralph-dev:phase-2-breakdown │                           │
│   └─────────────────────────────────────┘                               │
│         │                                                               │
│         │ Tasks created                                                 │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ Skill tool: ralph-dev:phase-3-implement │                           │
│   │                                     │                               │
│   │   for each task:                    │                               │
│   │     Task tool → fresh subagent      │────┐                          │
│   │                                     │    │                          │
│   │     if failed:                      │    │ TDD implementation       │
│   │       Skill: ralph-dev:phase-4-heal │◄───┘                          │
│   │                                     │                               │
│   └─────────────────────────────────────┘                               │
│         │                                                               │
│         │ All tasks done                                                │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ Skill tool: ralph-dev:phase-5-deliver │                             │
│   │                                     │                               │
│   │   Quality gates → commit → PR       │                               │
│   └─────────────────────────────────────┘                               │
│         │                                                               │
│         ▼                                                               │
│   ┌─────────────────────────────────────┐                               │
│   │ Complete                            │                               │
│   └─────────────────────────────────────┘                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Error Handling & Recovery

### Circuit Breaker Pattern

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    CIRCUIT BREAKER STATE MACHINE                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                         ┌──────────┐                                    │
│                         │  CLOSED  │◄─────────────────┐                 │
│                         │ (normal) │                  │                 │
│                         └──────────┘                  │                 │
│                              │                        │                 │
│                              │ 5 consecutive          │                 │
│                              │ failures               │                 │
│                              ▼                        │                 │
│                         ┌──────────┐                  │                 │
│                         │   OPEN   │                  │ 60 seconds      │
│                         │(fail-fast)│                 │ elapsed         │
│                         └──────────┘                  │                 │
│                              │                        │                 │
│                              │ after 60s              │                 │
│                              ▼                        │                 │
│                         ┌──────────┐                  │                 │
│                         │HALF-OPEN │──────────────────┘                 │
│                         │ (probe)  │    success                         │
│                         └──────────┘                                    │
│                              │                                          │
│                              │ failure                                  │
│                              ▼                                          │
│                         ┌──────────┐                                    │
│                         │   OPEN   │                                    │
│                         └──────────┘                                    │
│                                                                         │
│   Usage in Phase 4 Skill (ralph-dev:phase-4-heal):                      │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ // Circuit breaker logic is implemented in skill workflow:      │   │
│   │ // - Track consecutive failures per task                        │   │
│   │ // - After 5 failures: mark task as failed, skip to next        │   │
│   │ // - 60 second cooldown before retry                            │   │
│   │ //                                                              │   │
│   │ // Healing is handled by skills, not CLI services:              │   │
│   │ // 1. Skills invoke: ralph-dev tasks fail <id> --reason "..."   │   │
│   │ // 2. Skills track failure count in skill context               │   │
│   │ // 3. Skills decide when to open circuit (skip task)            │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Retry Logic with Exponential Backoff

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    RETRY WITH EXPONENTIAL BACKOFF                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Retryable Errors: EBUSY, ENOENT, EAGAIN, ETIMEDOUT                    │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                                                                 │   │
│   │   Attempt 1                                                     │   │
│   │       │                                                         │   │
│   │       │ fail (EBUSY)                                            │   │
│   │       ▼                                                         │   │
│   │   wait 100ms                                                    │   │
│   │       │                                                         │   │
│   │       ▼                                                         │   │
│   │   Attempt 2                                                     │   │
│   │       │                                                         │   │
│   │       │ fail (EBUSY)                                            │   │
│   │       ▼                                                         │   │
│   │   wait 200ms (2x)                                               │   │
│   │       │                                                         │   │
│   │       ▼                                                         │   │
│   │   Attempt 3                                                     │   │
│   │       │                                                         │   │
│   │       │ fail (EBUSY)                                            │   │
│   │       ▼                                                         │   │
│   │   throw Error (max attempts exceeded)                           │   │
│   │                                                                 │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   Configuration:                                                        │
│   - maxAttempts: 3                                                      │
│   - initialDelay: 100ms                                                 │
│   - maxDelay: 1000ms (cap)                                              │
│   - backoffMultiplier: 2                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### Exit Code Reference

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    CLI EXIT CODES                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Code │ Name           │ Description                                   │
│   ─────┼────────────────┼───────────────────────────────────────────    │
│   0    │ SUCCESS        │ Operation completed successfully              │
│   1    │ GENERAL_ERROR  │ Unexpected error, implementation issue        │
│   2    │ NOT_FOUND      │ Resource not found (task, state)              │
│   3    │ INVALID_INPUT  │ Bad arguments, validation failed              │
│   4    │ CONFLICT       │ Duplicate task ID, invalid transition         │
│   5    │ SYSTEM_ERROR   │ File system error, permission denied          │
│                                                                         │
│   Usage in Commands:                                                    │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │ import { ExitCode } from '../core/exit-codes';                  │   │
│   │                                                                 │   │
│   │ try {                                                           │   │
│   │   const task = await service.getTask(id);                       │   │
│   │   if (!task) {                                                  │   │
│   │     process.exit(ExitCode.NOT_FOUND);                           │   │
│   │   }                                                             │   │
│   │ } catch (e) {                                                   │   │
│   │   if (e.code === 'ENOENT') {                                    │   │
│   │     process.exit(ExitCode.SYSTEM_ERROR);                        │   │
│   │   }                                                             │   │
│   │   process.exit(ExitCode.GENERAL_ERROR);                         │   │
│   │ }                                                               │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Summary

Ralph-dev is a **state-driven, context-compression resilient** autonomous development system that:

1. **Transforms requirements** through 5 phases: Clarify → Breakdown → Implement ⇄ Heal → Deliver
2. **Persists all state** via CLI to survive context compression
3. **Implements with TDD** using fresh subagents per task
4. **Recovers from errors** with 4-phase healing and circuit breakers
5. **Delivers quality code** through automated gates and PR creation

The architecture enforces strict separation of concerns through layered CLI design and skill-based AI workflows, enabling reliable autonomous development from natural language to production-ready code.
